<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>VCU Student Healthcare Application</title>
    <style>
        /* Global Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none; /* Hide containers by default */
        }

        .container.active {
            display: block; /* Show active container */
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .message {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .password-strength {
            margin-top: 5px;
            font-size: 12px;
        }

        .password-strength-meter {
            height: 4px;
            background-color: #ddd;
            margin-top: 5px;
            border-radius: 2px;
        }

        .password-strength-meter div {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .strength-weak { background-color: #dc3545; }
        .strength-medium { background-color: #ffc107; }
        .strength-strong { background-color: #28a745; }

        .requirements-list {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
            padding-left: 20px;
        }

        .requirements-list li {
            margin-bottom: 3px;
        }

        .requirements-list li.valid {
            color: #28a745;
        }

        .requirements-list li.invalid {
            color: #dc3545;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        /* Dashboard Grid Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .dashboard-item {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .dashboard-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .dashboard-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: block;
        }

        .dashboard-item h2 {
            margin: 10px 0;
            color: #007bff;
        }

        .dashboard-item p {
            color: #666;
            margin: 0;
            font-size: 0.9em;
        }

        /* Enhanced Appointments Page Styles */
        .appointments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 0;
            border-bottom: 2px solid #e5e7eb;
        }

        .appointments-title {
            font-size: 1.875rem;
            font-weight: 600;
            color: #1a365d;
            margin: 0;
        }

        .search-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .search-date {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .search-date:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .appointments-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .appointments-table th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 600;
            text-align: left;
            padding: 1rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e2e8f0;
        }

        .appointments-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            font-size: 0.875rem;
        }

        .appointments-table tr:last-child td {
            border-bottom: none;
        }

        .appointments-table tr:hover {
            background-color: #f8fafc;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit, .btn-delete {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-edit {
            background-color: #e2e8f0;
            color: #475569;
        }

        .btn-edit:hover:not(:disabled) {
            background-color: #cbd5e1;
        }

        .btn-delete {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .btn-delete:hover:not(:disabled) {
            background-color: #fecaca;
        }

        .btn-edit:disabled, .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 32rem;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Spinner Enhancement */
        .spinner {
            border-width: 2px;
            border-color: #e2e8f0;
            border-top-color: #3b82f6;
            width: 1.25rem;
            height: 1.25rem;
            margin-left: 0.5rem;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-upcoming {
            background-color: #dbeafe;
            color: #1d4ed8;
        }

        .status-past {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .guardian-entry, .condition-entry {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        }
    
        .guardian-entry input, .condition-entry input {
            flex: 1;
        }
        
        #deletionWarning {
            background-color: #dc3545;
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        #searchResults {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="container active">
        <h1>VCU Student Healthcare</h1>
        <div id="loginMessage" class="message"></div>
        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" required>
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" required>
        </div>
        <button class="btn btn-primary" onclick="login()">
            Login
            <span id="loginSpinner" class="spinner"></span>
        </button>
        <button class="btn btn-secondary" onclick="showPage('registerPage')">Register New Account</button>
    </div>

    <!-- Home Page -->
    <div id="homePage" class="container">
        <h1>Welcome, <span id="userFullName"></span></h1>
        
        <div class="dashboard-grid">
            <div class="dashboard-item" onclick="showAppointmentsPage()">
                <i class="dashboard-icon">üìÖ</i>
                <h2>Appointments</h2>
                <p>Schedule and manage your medical appointments</p>
            </div>
            
            <div class="dashboard-item" onclick="showPrescriptionsPage()">
                <i class="dashboard-icon">üíä</i>
                <h2>Prescriptions</h2>
                <p>View and manage your prescriptions</p>
            </div>
            
            <div class="dashboard-item" onclick="showPage('patientInfoPage')">
                <i class="dashboard-icon">üìã</i>
                <h2>Patient Information</h2>
                <p>Access patient medical records and personal information</p>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="logout()" style="margin-top: 20px;">Logout</button>
    </div>

    <!-- Appointments Page -->
    <div id="appointmentsPage" class="container">
        <div class="appointments-header">
            <h1 class="appointments-title">Appointments</h1>
            <button class="btn btn-primary" onclick="showNewAppointmentPage()">New Appointment</button>
        </div>
        
        <div class="search-controls">
            <div class="search-group">
                <input type="date" id="searchDate" class="search-date">
                <button onclick="searchAppointments()" class="btn btn-primary">Search</button>
                <button onclick="loadAppointments()" class="btn btn-secondary">
                    Refresh
                    <span id="refreshSpinner" class="spinner"></span>
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="appointments-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Location</th>
                        <th>Doctor</th>
                        <th>Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="appointmentsList">
                    <!-- Appointments will be populated here -->
                </tbody>
            </table>
        </div>

        <button class="btn btn-secondary mt-4" onclick="showPage('homePage')">Back to Home</button>

        <!-- Edit Appointment Modal -->
        <div id="editModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Edit Appointment</h2>
                <form id="editAppointmentForm" onsubmit="updateAppointment(event)">
                    <input type="hidden" id="editAppointmentId">
                    <div class="form-group">
                        <label>Date:</label>
                        <input type="date" id="editDate" required class="w-full p-2 border rounded">
                    </div>
                    <div class="form-group">
                        <label>Time:</label>
                        <input type="time" id="editTime" required class="w-full p-2 border rounded">
                    </div>
                    <div class="form-group">
                        <label>Reason:</label>
                        <textarea id="editReason" required class="w-full p-2 border rounded"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeEditModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
                <p class="modal-body">Are you sure you want to delete this appointment?</p>
                <div class="modal-footer">
                    <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
                    <button onclick="confirmDelete()" class="btn btn-primary">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Appointment Page -->
    <div id="newAppointmentPage" class="container">
        <h1>Schedule New Appointment</h1>
        
        <form id="newAppointmentForm" onsubmit="createNewAppointment(event)">
            <div class="form-group">
                <label for="location">Location:</label>
                <input type="text" id="location" required oninput="searchHospitals(this.value)">
                <div id="hospitalSuggestions" class="mt-2"></div>
                <div id="locationMessage" class="message"></div>
            </div>
            
            <div class="form-group">
                <label for="doctor">Doctor:</label>
                <select id="doctor" required>
                    <option value="">Select a doctor</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="appointmentDate">Date:</label>
                <input type="date" id="appointmentDate" required>
            </div>
            
            <div class="form-group">
                <label for="appointmentTime">Time:</label>
                <select id="appointmentTime" required>
                    <option value="">Select a time</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reason">Reason for Visit:</label>
                <textarea id="reason" required></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">Schedule Appointment</button>
            <button type="button" class="btn btn-secondary" onclick="showPage('appointmentsPage')">Cancel</button>
        </form>
    </div>

    <!-- Prescriptions Page -->
    <div id="prescriptionsPage" class="container">
        <div class="appointments-header">
            <h1 class="appointments-title">Prescriptions</h1>
            <button class="btn btn-primary" onclick="showNewPrescriptionPage()">New Prescription</button>
        </div>
        
        <div class="search-controls">
            <div class="search-group">
                <button onclick="loadPrescriptions()" class="btn btn-secondary">
                    Refresh
                    <span id="prescriptionsRefreshSpinner" class="spinner"></span>
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="appointments-table">
                <thead>
                    <tr>
                        <th>Medication</th>
                        <th>Dosage (mg)</th>
                        <th>Frequency</th>
                        <th>Pharmacy</th>
                        <th>Next Refill Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="prescriptionsList">
                    <!-- Prescriptions will be populated here -->
                </tbody>
            </table>
        </div>

        <button class="btn btn-secondary mt-4" onclick="showPage('homePage')">Back to Home</button>

        <!-- Edit Prescription Modal -->
        <div id="editPrescriptionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Edit Prescription</h2>
                <form id="editPrescriptionForm" onsubmit="updatePrescription(event)">
                    <input type="hidden" id="editPrescriptionId">
                    <div class="form-group">
                        <label>Medication Name:</label>
                        <input type="text" id="editMedication" required class="w-full p-2 border rounded">
                    </div>
                    <div class="form-group">
                        <label>Dosage (mg):</label>
                        <input type="number" id="editDosage" required min="1" class="w-full p-2 border rounded">
                    </div>
                    <div class="form-group">
                        <label>Frequency:</label>
                        <select id="editFrequency" required class="w-full p-2 border rounded">
                            <option value="15">15 Days</option>
                            <option value="30">30 Days</option>
                            <option value="60">60 Days</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pharmacy:</label>
                        <input type="text" id="editPharmacy" required class="w-full p-2 border rounded">
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeEditPrescriptionModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deletePrescriptionModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
                <p class="modal-body">Are you sure you want to delete this prescription?</p>
                <div class="modal-footer">
                    <button onclick="closeDeletePrescriptionModal()" class="btn btn-secondary">Cancel</button>
                    <button onclick="confirmPrescriptionDelete()" class="btn btn-primary">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="newPrescriptionPage" class="container">
        <h1>New Prescription</h1>
        
        <form id="newPrescriptionForm" onsubmit="createNewPrescription(event)">
            <div class="form-group">
                <label for="medication">Medication Name:</label>
                <input type="text" id="medication" required>
            </div>
            
            <div class="form-group">
                <label for="dosage">Dosage (mg):</label>
                <input type="number" id="dosage" required min="1">
            </div>
            
            <div class="form-group">
                <label for="frequency">Frequency:</label>
                <select id="frequency" required>
                    <option value="15">15 Days</option>
                    <option value="30">30 Days</option>
                    <option value="60">60 Days</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="pharmacy">Pharmacy Location:</label>
                <input type="text" id="pharmacy" required oninput="searchPharmacies(this.value)">
                <div id="pharmacySuggestions" class="mt-2"></div>
                <div id="pharmacyMessage" class="message"></div>
            </div>
            
            <button type="submit" class="btn btn-primary">Create Prescription</button>
            <button type="button" class="btn btn-secondary" onclick="showPage('prescriptionsPage')">Cancel</button>
        </form>
    </div>

    <!-- Patient Information Page -->
    <div id="patientInfoPage" class="container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Patient Information</h1>
        </div>
        
        <div class="dashboard-grid">
            <div class="dashboard-item" onclick="showAddPatientPage()">
                <i class="dashboard-icon">üë§</i>
                <h2>Add Patient</h2>
                <p>Create a new patient record</p>
            </div>
            
            <div class="dashboard-item" onclick="showSearchPatientPage()">
                <i class="dashboard-icon">üîç</i>
                <h2>Search Patient</h2>
                <p>Find and manage existing patient records</p>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="showPage('homePage')">Back to Home</button>
    </div>

    <!-- Add Patient Page -->
    <div id="addPatientPage" class="container">
        <h1>Add New Patient</h1>
        
        <form id="addPatientForm" onsubmit="createNewPatient(event)">
            <div class="form-group">
                <label for="patientName">Name:</label>
                <input type="text" id="patientName" required>
            </div>
            
            <div class="form-group">
                <label for="patientSex">Sex:</label>
                <select id="patientSex" required>
                    <option value="">Select sex</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="patientGender">Gender:</label>
                <input type="text" id="patientGender" placeholder="Optional">
            </div>
            
            <div class="form-group">
                <label for="insuranceInfo">Insurance Information:</label>
                <textarea id="insuranceInfo" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="patientEmail">Email:</label>
                <input type="email" id="patientEmail" required>
            </div>
            
            <div class="form-group">
                <label for="patientPhone">Phone:</label>
                <input type="tel" id="patientPhone" required pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" placeholder="123-456-7890">
            </div>
            
            <div class="form-group">
                <label>Guardians:</label>
                <div id="guardiansList">
                    <!-- Guardian entries will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addGuardianField()">Add Guardian</button>
            </div>
            
            <div class="form-group">
                <label>Medical Conditions:</label>
                <div id="conditionsList">
                    <!-- Condition entries will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addConditionField()">Add Condition</button>
            </div>

            <div class="form-group">
                <label for="patientNotes">Notes:</label>
                <textarea id="patientNotes" rows="4" class="w-full p-2 border rounded"
                          placeholder="Enter any additional notes about the patient"></textarea>
            </div>

            <div class="form-group">
                <label for="medicalHistory">Medical History:</label>
                <textarea id="medicalHistory" rows="6" class="w-full p-2 border rounded"
                          placeholder="Enter patient's medical history, including past conditions, surgeries, and treatments"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">Confirm Patient</button>
            <button type="button" class="btn btn-secondary" onclick="showPage('patientInfoPage')">Back</button>
        </form>
    </div>

    <!-- Search Patient Page -->
    <div id="searchPatientPage" class="container">
        <h1>Search Patient Records</h1>
        
        <div id="passwordPrompt" class="modal">
            <div class="modal-content">
                <h2>Authentication Required</h2>
                <div class="form-group">
                    <label for="providerPassword">Please enter your password:</label>
                    <input type="password" id="providerPassword" required>
                </div>
                <div class="modal-footer">
                    <button onclick="validateProviderAccess()" class="btn btn-primary">Submit</button>
                    <button onclick="closePasswordPrompt()" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
        
        <div id="searchForm" style="display: none;">
            <div class="form-group">
                <label for="searchName">Patient Name:</label>
                <input type="text" id="searchName" required>
                <button onclick="searchForPatient()" class="btn btn-primary">Search</button>
            </div>
            
            <div id="searchResults" class="mt-4">
                <!-- Search results will be displayed here -->
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="showPage('patientInfoPage')">Back</button>
    </div>

    <!-- Patient Details Page -->
    <div id="patientDetailsPage" class="container">
        <h1>Patient Details</h1>
        
        <form id="patientDetailsForm">
            <div id="deletionWarning" class="message error-message" style="display: none;">
                PATIENT FILE WILL BE DELETED ON <span id="deletionDate"></span>. SELECT UNDO TO CANCEL DELETION
            </div>
            
            <div class="form-group">
                <label for="editPatientName">Name:</label>
                <input type="text" id="editPatientName" required>
            </div>
            
            <div class="form-group">
                <label for="editPatientSex">Sex:</label>
                <select id="editPatientSex" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editPatientGender">Gender:</label>
                <input type="text" id="editPatientGender">
            </div>
            
            <div class="form-group">
                <label for="editInsuranceInfo">Insurance Information:</label>
                <textarea id="editInsuranceInfo" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="editPatientEmail">Email:</label>
                <input type="email" id="editPatientEmail" required>
            </div>
            
            <div class="form-group">
                <label for="editPatientPhone">Phone:</label>
                <input type="tel" id="editPatientPhone" required pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}">
            </div>
            
            <div class="form-group">
                <label>Guardians:</label>
                <div id="editGuardiansList">
                    <!-- Guardian entries will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addGuardianField()">Add Guardian</button>
            </div>
            
            <div class="form-group">
                <label>Medical Conditions:</label>
                <div id="editConditionsList">
                    <!-- Condition entries will be added here -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addEditConditionField()">Add Condition</button>
            </div>
            
            <div class="form-group">
                <label for="editPatientNotes">Notes:</label>
                <textarea id="editPatientNotes" rows="4" class="w-full p-2 border rounded"
                          placeholder="Enter any additional notes about the patient"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editMedicalHistory">Medical History:</label>
                <textarea id="editMedicalHistory" rows="6" class="w-full p-2 border rounded"
                          placeholder="Enter patient's medical history, including past conditions, surgeries, and treatments"></textarea>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn btn-primary" onclick="confirmEditPatient()">Confirm Edits</button>
                <button type="button" class="btn btn-secondary" onclick="undoChanges()">Undo</button>
                <button type="button" class="btn btn-primary" onclick="showDeleteConfirmation()">Delete Patient</button>
                <button type="button" class="btn btn-secondary" onclick="showSearchPatientPage()">Back</button>
            </div>
        </form>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Confirm Changes</h2>
            <p>Are you sure you want to save these changes?</p>
            <div class="modal-footer">
                <button onclick="savePatientChanges()" class="btn btn-primary">Yes</button>
                <button onclick="closeConfirmationModal()" class="btn btn-secondary">No</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Password Required</h2>
            <div class="form-group">
                <label for="deletePassword">Please enter your password:</label>
                <input type="password" id="deletePassword" required>
            </div>
            <h2>Confirm Deletion</h2>
            <p>Are you sure you want to delete this patient?</p>
            <div class="modal-footer">
                <button onclick="confirmDeletePatient()" class="btn btn-primary">Yes</button>
                <button onclick="closeDeleteConfirmationModal()" class="btn btn-secondary">No</button>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="container">
        <h1>Register New Account</h1>
        <div id="registerMessage" class="message"></div>
        
        <form id="registerForm" onsubmit="register(event)">
            <div class="form-group">
                <label for="regUsername">Username:</label>
                <input type="text" id="regUsername" required minlength="5" 
                       oninput="validateUsername(this)">
                <ul class="requirements-list" id="usernameRequirements">
                    <li>At least 5 characters long</li>
                    <li>Can contain letters, numbers, and underscores</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" required 
                       oninput="validatePassword(this)">
                <div class="password-strength">
                    Password Strength: <span id="strengthText">None</span>
                    <div class="password-strength-meter">
                        <div id="strengthMeter" style="width: 0%"></div>
                    </div>
                </div>
                <ul class="requirements-list" id="passwordRequirements">
                    <li>At least 8 characters long</li>
                    <li>Contains at least one uppercase letter</li>
                    <li>Contains at least one lowercase letter</li>
                    <li>Contains at least one number</li>
                    <li>Contains at least one special character</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" required 
                       oninput="validatePasswordMatch()">
            </div>

            <div class="form-group">
                <label for="fullName">Full Name:</label>
                <input type="text" id="fullName" required 
                       pattern="[A-Za-z ]{2,50}"
                       title="Please enter a valid name (2-50 characters, letters only)">
            </div>

            <div class="form-group">
                <label for="email">Email Address:</label>
                <input type="email" id="email" required
                       pattern=".+@.+\..+"
                       title="Please enter a valid email address">
            </div>

            <button type="submit" class="btn btn-primary" id="registerButton">
                Register
                <span id="registerSpinner" class="spinner"></span>
            </button>
            <button type="button" class="btn btn-secondary" onclick="showPage('loginPage')">Go Back</button>
        </form>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=[APIKEY]&libraries=places"></script>
    <script>
        // Google Maps Places API Integration with Address Input
        async function searchNearbyHospitals(address) {
          // Create a Geocoder instance to convert address to coordinates
          const geocoder = new google.maps.Geocoder();
          const service = new google.maps.places.PlacesService(document.createElement('div'));

          // First, convert the address to coordinates
          try {
            const geocodeResult = await new Promise((resolve, reject) => {
              geocoder.geocode({ address: address }, (results, status) => {
                if (status === google.maps.GeocoderStatus.OK && results[0]) {
                  resolve(results[0].geometry.location);
                } else {
                  reject(new Error(`Geocoding failed: ${status}`));
                }
              });
            });

            // Define the search request using the geocoded location
            const request = {
              location: geocodeResult,
              radius: 5000,
              type: ['hospital']
            };

            // Perform the nearby search
            return new Promise((resolve, reject) => {
              service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                  // Map the results to a cleaner format
                  const hospitals = results.map(place => ({
                    name: place.name,
                    address: place.vicinity,
                    location: {
                      lat: place.geometry.location.lat(),
                      lng: place.geometry.location.lng()
                    },
                    rating: place.rating,
                    userRatingsTotal: place.user_ratings_total,
                    placeId: place.place_id,
                    openNow: place.opening_hours?.isOpen() || null,
                    photos: place.photos?.map(photo => photo.getUrl()) || [],
                  }));
                  
                  resolve(hospitals);
                } else {
                  reject(new Error(`Places search failed: ${status}`));
                }
              });
            });
          } catch (error) {
            throw new Error(`Address lookup failed: ${error.message}`);
          }
        }

        // Page navigation
        function showPage(pageId) {
            // Hide all containers
            document.querySelectorAll('.container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Show selected container
            document.getElementById(pageId).classList.add('active');
            
            // Clear messages when switching pages
            document.querySelectorAll('.message').forEach(message => {
                message.style.display = 'none';
            });
        }

        // Form validation functions
        function validateUsername(input) {
            const requirements = document.getElementById('usernameRequirements').children;
            const username = input.value;
            
            requirements[0].className = username.length >= 5 ? 'valid' : 'invalid';
            requirements[1].className = /^[A-Za-z0-9_]+$/.test(username) ? 'valid' : 'invalid';
            
            return requirements[0].className === 'valid' && requirements[1].className === 'valid';
        }

        function validatePassword(input) {
            const requirements = document.getElementById('passwordRequirements').children;
            const password = input.value;
            
            requirements[0].className = password.length >= 8 ? 'valid' : 'invalid';
            requirements[1].className = /[A-Z]/.test(password) ? 'valid' : 'invalid';
            requirements[2].className = /[a-z]/.test(password) ? 'valid' : 'invalid';
            requirements[3].className = /[0-9]/.test(password) ? 'valid' : 'invalid';
            requirements[4].className = /[^A-Za-z0-9]/.test(password) ? 'valid' : 'invalid';
            
            let strength = 0;
            if(password.length >= 8) strength++;
            if(/[A-Z]/.test(password)) strength++;
            if(/[a-z]/.test(password)) strength++;
            if(/[0-9]/.test(password)) strength++;
            if(/[^A-Za-z0-9]/.test(password)) strength++;
            
            const meter = document.getElementById('strengthMeter');
            const strengthText = document.getElementById('strengthText');
            
            switch(strength) {
                case 0:
                case 1:
                    meter.className = 'strength-weak';
                    meter.style.width = '20%';
                    strengthText.textContent = 'Weak';
                    break;
                case 2:
                case 3:
                    meter.className = 'strength-medium';
                    meter.style.width = '60%';
                    strengthText.textContent = 'Medium';
                    break;
                case 4:
                case 5:
                    meter.className = 'strength-strong';
                    meter.style.width = '100%';
                    strengthText.textContent = 'Strong';
                    break;
            }
            
            return strength >= 4;
        }

        function validatePasswordMatch() {
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            return password === confirm;
        }

        // Global variable to store user data
        let currentUser = null;
        let isProvider = false;

        // Login function
        function login() {
            document.getElementById('loginSpinner').style.display = 'inline-block';
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            google.script.run
                .withSuccessHandler((user) => {
                    if (user) {
                        currentUser = user;
                        isProvider = user.role === 'PROVIDER';
                        document.getElementById('userFullName').textContent = user.fullName;
                        showPage('homePage');
                        updateUIForRole();
                        showMessage('loginMessage', 'Login successful!', 'success');
                    } else {
                        showMessage('loginMessage', 'Invalid username or password', 'error');
                    }
                    document.getElementById('loginSpinner').style.display = 'none';
                })
                .withFailureHandler((error) => {
                    showMessage('loginMessage', 'Login failed. Please try again.', 'error');
                    document.getElementById('loginSpinner').style.display = 'none';
                })
                .validateLogin(username, password);
        }

        function updateUIForRole() {
            // Update dashboard items visibility
            const patientInfoItem = document.querySelector('.dashboard-item[onclick="showPage(\'patientInfoPage\')"]');
            if (patientInfoItem) {
                patientInfoItem.style.display = isProvider ? 'block' : 'none';
            }
            
            // Update prescription controls
            const prescriptionControls = document.querySelectorAll('.prescription-control');
            prescriptionControls.forEach(control => {
                control.style.display = isProvider ? 'inline-block' : 'none';
            });
            
            // Hide new prescription button for non-providers
            const newPrescriptionBtn = document.querySelector('button[onclick="showNewPrescriptionPage()"]');
            if (newPrescriptionBtn) {
                newPrescriptionBtn.style.display = isProvider ? 'block' : 'none';
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showPage('loginPage');
        }

        function showAppointmentsPage(){
          showPage('appointmentsPage');
          initAppointmentsPage();
        }

        // Enhanced showPage function
        function showPage(pageId) {
            // Check if user is logged in for protected pages
            if (pageId !== 'loginPage' && pageId !== 'registerPage' && !currentUser) {
                showPage('loginPage');
                return;
            }
            
            // Hide all containers
            document.querySelectorAll('.container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Show selected container
            document.getElementById(pageId).classList.add('active');
            
            // Clear messages when switching pages
            document.querySelectorAll('.message').forEach(message => {
                message.style.display = 'none';
            });
        }

        // Form submissions
        function register(event) {
            event.preventDefault();
            
            // Show spinner
            document.getElementById('registerSpinner').style.display = 'inline-block';
            document.getElementById('registerButton').disabled = true;
            
            // Clear previous messages
            const messageDiv = document.getElementById('registerMessage');
            messageDiv.style.display = 'none';
            
            // Validate all inputs
            if (!validateUsername(document.getElementById('regUsername')) ||
                !validatePassword(document.getElementById('regPassword')) ||
                !validatePasswordMatch()) {
                showMessage('registerMessage', 'Please fix the errors in the form.', 'error');
                document.getElementById('registerSpinner').style.display = 'none';
                document.getElementById('registerButton').disabled = false;
                return;
            }
            
            const userData = {
                username: document.getElementById('regUsername').value,
                password: document.getElementById('regPassword').value,
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value
            };
            
            // Call Google Apps Script function
            google.script.run
                .withSuccessHandler((result) => {
                    showMessage('registerMessage', 'Registration successful! You can now login.', 'success');
                    document.getElementById('registerSpinner').style.display = 'none';
                    document.getElementById('registerButton').disabled = false;
                    
                    // Clear the form
                    document.getElementById('registerForm').reset();
                    
                    // Redirect to login page after successful registration
                    setTimeout(() => showPage('loginPage'), 2000);
                })
                .withFailureHandler((error) => {
                    showMessage('registerMessage', error.message || 'Registration failed. Please try again.', 'error');
                    document.getElementById('registerSpinner').style.display = 'none';
                    document.getElementById('registerButton').disabled = false;
                })
                .registerUser(
                    userData.username,
                    userData.password,
                    userData.fullName,
                    userData.email
                );
        }

        function showMessage(elementId, message, type) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + (type === 'error' ? 'error-message' : 'success-message');
            messageDiv.style.display = 'block';
        }

        let currentAppointments = [];
        let selectedAppointmentId = null;

        // Initialize appointments page
        function initAppointmentsPage() {
            console.log("Initialzing");
            
            loadAppointments();
            document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];
            loadDoctors();
        }

        // Load appointments from server
        function loadAppointments() {
            document.getElementById('refreshSpinner').style.display = 'inline-block';
            console.log("Getting Appointments for: "+currentUser.username);
            google.script.run
                .withSuccessHandler(displayAppointments)
                .withFailureHandler(handleError)
                .getAppointments(currentUser.username);
        }

        // Display appointments in the table
        function displayAppointments(appointments) {
            appointments = JSON.parse(appointments);
            currentAppointments = appointments;
            console.log(appointments);
            const tbody = document.getElementById('appointmentsList');
            tbody.innerHTML = '';
            
            appointments.sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(apt => {
                    const row = document.createElement('tr');

                    let date = new Date(apt.date);
                    let time = new Date(apt.time);
                    let dateTime = new Date(date.getTime() + (time.getHours() * 60 * 60 * 1000) + (time.getMinutes() * 60 * 1000));
                    const today = new Date()
                    const isWithin24Hours = (dateTime.getTime() - today.getTime()) < (24 * 60 * 60 * 1000);
                    console.log(dateTime.getTime() - today.getTime())
                    
                    date = (date.getMonth()+1)+"/"+date.getDate()+"/"+date.getFullYear();
                    let hours = time.getHours();
                    let ampm = "AM";
                    if(hours > 12) {
                      hours -= 12;
                      ampm = "PM";
                    }
                    let minutes = time.getMinutes().toString();
                    if(minutes.length < 2) minutes = "0"+minutes;
                    time = hours+":"+minutes+" "+ampm;
                    let doctor = "Dr. "+apt.doctor;

                    row.innerHTML = `
                        <td class="p-2 border">${date}</td>
                        <td class="p-2 border">${time}</td>
                        <td class="p-2 border">${apt.location}</td>
                        <td class="p-2 border">${doctor}</td>
                        <td class="p-2 border">${apt.reason}</td>
                        <td class="p-2 border">
                            <button onclick="showEditModal('${apt.id}')" 
                                    class="btn btn-secondary btn-sm mr-2" 
                                    ${isWithin24Hours ? 'hidden' : ''}>
                                Edit
                            </button>
                            <button onclick="showDeleteModal('${apt.id}')" 
                                    class="btn btn-primary btn-sm"
                                    ${isWithin24Hours ? 'hidden' : ''}>
                                Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            
            document.getElementById('refreshSpinner').style.display = 'none';
        }

        function isWithin24Hours(dateStr, timeStr) {
            // Combine date and time strings
            const dateTimeStr = `${dateStr}T${timeStr}:00`;
            
            // Create Date objects for the input time and current time
            const inputDateTime = new Date(dateTimeStr);
            const currentDateTime = new Date();
            
            // Check if input date is valid
            if (isNaN(inputDateTime.getTime())) {
                throw new Error('Invalid date or time format. Please use YYYY-MM-DD for date and HH:MM for time');
            }
            
            // Calculate difference in milliseconds
            const timeDifference = inputDateTime - currentDateTime;
            
            // Convert 24 hours to milliseconds
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            // Check if the time is in the future and within 24 hours
            return timeDifference > 0 && timeDifference <= twentyFourHours;
        }

        // Search appointments
        function searchAppointments() {
            const searchDate = document.getElementById('searchDate').value;
            if (!searchDate) {
                displayAppointments(currentAppointments);
                return;
            }
            
            google.script.run
                .withSuccessHandler(displayAppointments)
                .withFailureHandler(handleError)
                .searchAppointments(currentUser.username, searchDate);
        }

        function setupEditDateTimeValidation() {
            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            
            // Add validation to the date input
            const dateInput = document.getElementById('editDate');
            dateInput.min = minDate;
            
            // Add event listeners to both date and time inputs
            dateInput.addEventListener('change', validateDateTime);
            document.getElementById('editTime').addEventListener('change', validateDateTime);
        }

        function validateDateTime() {
            const dateInput = document.getElementById('editDate');
            const timeInput = document.getElementById('editTime');
            
            if (dateInput.value && timeInput.value) {
                const selectedDateTime = new Date(`${dateInput.value} ${timeInput.value}`);
                const now = new Date();
                const hoursDifference = (selectedDateTime - now) / (1000 * 60 * 60);
                
                if (hoursDifference < 24) {
                    alert('Appointments must be at least 24 hours in the future');
                    // Reset the inputs
                    dateInput.value = '';
                    timeInput.value = '';
                }
            }
        }

        function showEditModal(appointmentId) {
            const appointment = currentAppointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;
            
            selectedAppointmentId = appointmentId;
            document.getElementById('editAppointmentId').value = appointmentId;
            document.getElementById('editDate').value = appointment.date;
            document.getElementById('editTime').value = appointment.time;
            document.getElementById('editReason').value = appointment.reason;
            
            document.getElementById('editModal').style.display = 'block';
            
            // Setup validation after showing modal
            setupEditDateTimeValidation();
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            selectedAppointmentId = null;
        }

        function updateAppointment(event) {
          event.preventDefault();
          
          const newDate = document.getElementById('editDate').value;
          const newTime = document.getElementById('editTime').value;
          const newDateTime = new Date(`${newDate} ${newTime}`);
          const now = new Date();
          const hoursDifference = (newDateTime - now) / (1000 * 60 * 60);
          
          // Check if appointment is less than 24 hours in the future
          if (hoursDifference < 24) {
              alert('Appointments must be at least 24 hours in the future');
              return;
          }
          
          const updatedData = {
              date: newDate,
              time: newTime,
              reason: document.getElementById('editReason').value
          };
          
          google.script.run
              .withSuccessHandler(() => {
                  closeEditModal();
                  loadAppointments();
              })
              .withFailureHandler(handleError)
              .editAppointment(selectedAppointmentId, updatedData);
      }

        // Delete appointment functions
        function showDeleteModal(appointmentId) {
            selectedAppointmentId = appointmentId;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            selectedAppointmentId = null;
        }

        function confirmDelete() {
            if (!selectedAppointmentId) return;
            
            google.script.run
                .withSuccessHandler(() => {
                    closeDeleteModal();
                    loadAppointments();
                })
                .withFailureHandler(handleError)
                .deleteAppointment(selectedAppointmentId);
        }

        function showNewAppointmentPage() {
            // Hide all containers first
            document.querySelectorAll('.container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Show the new appointment page
            const newAppointmentPage = document.getElementById('newAppointmentPage');
            newAppointmentPage.classList.add('active');
            
            // Initialize the form
            initializeNewAppointmentForm();
        }

        function initializeNewAppointmentForm() {
            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('appointmentDate').min = tomorrow.toISOString().split('T')[0];
            
            // Clear previous form data
            document.getElementById('newAppointmentForm').reset();
            
            // Load doctors list
            loadDoctors();
            
            // Initialize time slots
            updateTimeSlots();
            
            // Clear any previous messages
            document.getElementById('locationMessage').style.display = 'none';
            document.getElementById('hospitalSuggestions').innerHTML = '';
        }

        function loadDoctors() {
            google.script.run
                .withSuccessHandler(populateDoctorsDropdown)
                .withFailureHandler(handleError)
                .getDoctors();
        }

        function populateDoctorsDropdown(doctors) {
            const select = document.getElementById('doctor');
            select.innerHTML = '<option value="">Select a doctor</option>';
            doctors.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.name;
                option.textContent = `Dr. ${doctor.name} - ${doctor.specialty}`;
                select.appendChild(option);
            });
        }

        async function searchHospitals(query) {
            if (query.length < 10) return;
            
            try{
              const hospitals = await searchNearbyHospitals(query);
              showMessage('locationMessage', '', 'success');
              displayHospitalSuggestions(hospitals);
            } catch(e) {
              showMessage('locationMessage', 'Invalid Address', 'error');
              displayHospitalSuggestions();
            }
        }

        function displayHospitalSuggestions(hospitals) {
            const container = document.getElementById('hospitalSuggestions');
            container.innerHTML = '';
            
            hospitals.forEach(hospital => {
                const div = document.createElement('div');
                div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                div.textContent = hospital.name;
                div.onclick = () => {
                    document.getElementById('location').value = hospital.name;
                    container.innerHTML = '';
                };
                container.appendChild(div);
            });
        }

        function updateTimeSlots() {
            const select = document.getElementById('appointmentTime');
            select.innerHTML = '';
            
            // Generate time slots from 9 AM to 5 PM
            for (let hour = 9; hour < 17; hour++) {
                ['00', '30'].forEach(minutes => {
                    const option = document.createElement('option');
                    option.value = `${hour}:${minutes}`;
                    option.textContent = `${hour > 12 ? hour - 12 : hour}:${minutes} ${hour >= 12 ? 'PM' : 'AM'}`;
                    select.appendChild(option);
                });
            }
        }

        function createNewAppointment(event) {
            event.preventDefault();
            
            const appointmentData = {
                username: currentUser.username,
                location: document.getElementById('location').value,
                doctor: document.getElementById('doctor').value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                reason: document.getElementById('reason').value
            };
            
            google.script.run
                .withSuccessHandler(() => {
                    showPage('appointmentsPage');
                    loadAppointments();
                })
                .withFailureHandler(handleError)
                .createAppointment(appointmentData);
        }

        function handleError(error) {
            if (error.message && error.message.includes('Unauthorized')) {
                alert('You do not have permission to perform this action. Please contact a provider.');
            } else {
                alert(error.message || 'An error occurred. Please try again.');
            }
        }

        let currentPrescriptions = [];
        let selectedPrescriptionId = null;

        // Initialize prescriptions page
        function showPrescriptionsPage(){
          showPage('prescriptionsPage')
          loadPrescriptions();
        }

        // Load prescriptions from server
        function loadPrescriptions() {
            document.getElementById('prescriptionsRefreshSpinner').style.display = 'inline-block';
            google.script.run
                .withSuccessHandler(displayPrescriptions)
                .withFailureHandler(handleError)
                .getPrescriptions(currentUser.username);
        }

        // Display prescriptions in the table
        function displayPrescriptions(prescriptions) {
            prescriptions = JSON.parse(prescriptions);
            currentPrescriptions = prescriptions;
            const tbody = document.getElementById('prescriptionsList');
            tbody.innerHTML = '';
            
            prescriptions.forEach(rx => {
                const row = document.createElement('tr');
                const nextRefillDate = new Date(rx.nextRefillDate);
                const today = new Date();
                const canRefill = nextRefillDate <= today;
                
                const actionsHtml = isProvider ? `
                    <button onclick="refillPrescription('${rx.id}')" 
                            class="btn btn-primary btn-sm mr-2 prescription-control"
                            ${canRefill ? '' : 'hidden'}>
                        Refill
                    </button>
                    <button onclick="showEditPrescriptionModal('${rx.id}')" 
                            class="btn btn-secondary btn-sm mr-2 prescription-control">
                        Edit
                    </button>
                    <button onclick="showDeletePrescriptionModal('${rx.id}')" 
                            class="btn btn-primary btn-sm prescription-control">
                        Delete
                    </button>
                ` : '';
                
                row.innerHTML = `
                    <td class="p-2 border">${rx.medication}</td>
                    <td class="p-2 border">${rx.dosage}</td>
                    <td class="p-2 border">${rx.frequency} Days</td>
                    <td class="p-2 border">${rx.pharmacy}</td>
                    <td class="p-2 border">${nextRefillDate.toLocaleDateString()}</td>
                    <td class="p-2 border">
                        ${actionsHtml}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('prescriptionsRefreshSpinner').style.display = 'none';
        }

        async function searchPharmacies(query) {
            if (query.length < 10) return;
            
            try {
                const pharmacies = await searchNearbyPharmacies(query);
                showMessage('pharmacyMessage', '', 'success');
                displayPharmacySuggestions(pharmacies);
            } catch(e) {
                showMessage('pharmacyMessage', 'Invalid Address', 'error');
                displayPharmacySuggestions([]);
            }
        }

        async function searchNearbyPharmacies(address) {
            const geocoder = new google.maps.Geocoder();
            const service = new google.maps.places.PlacesService(document.createElement('div'));

            try {
                const geocodeResult = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            resolve(results[0].geometry.location);
                        } else {
                            reject(new Error(`Geocoding failed: ${status}`));
                        }
                    });
                });

                const request = {
                    location: geocodeResult,
                    radius: 5000,
                    type: ['pharmacy']
                };

                return new Promise((resolve, reject) => {
                    service.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            const pharmacies = results.map(place => ({
                                name: place.name,
                                address: place.vicinity,
                                location: {
                                    lat: place.geometry.location.lat(),
                                    lng: place.geometry.location.lng()
                                }
                            }));
                            resolve(pharmacies);
                        } else {
                            reject(new Error(`Places search failed: ${status}`));
                        }
                    });
                });
            } catch (error) {
                throw new Error(`Address lookup failed: ${error.message}`);
            }
        }

        function displayPharmacySuggestions(pharmacies) {
            const container = document.getElementById('pharmacySuggestions');
            container.innerHTML = '';
            
            pharmacies.forEach(pharmacy => {
                const div = document.createElement('div');
                div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                div.textContent = `${pharmacy.name} - ${pharmacy.address}`;
                div.onclick = () => {
                    document.getElementById('pharmacy').value = pharmacy.name+"-"+pharmacy.address;
                    container.innerHTML = '';
                };
                container.appendChild(div);
            });
        }

        function showNewPrescriptionPage() {
            showPage('newPrescriptionPage');
        }

        function createNewPrescription(event) {
            event.preventDefault();
            
            const prescriptionData = {
                username: currentUser.username,
                medication: document.getElementById('medication').value,
                dosage: document.getElementById('dosage').value,
                frequency: document.getElementById('frequency').value,
                pharmacy: document.getElementById('pharmacy').value
            };
            
            google.script.run
                .withSuccessHandler(() => {
                    showPage('prescriptionsPage');
                    loadPrescriptions();
                })
                .withFailureHandler(handleError)
                .createPrescription(prescriptionData);
        }

        function showEditPrescriptionModal(prescriptionId) {
            const prescription = currentPrescriptions.find(rx => rx.id === prescriptionId);
            if (!prescription) return;
            
            selectedPrescriptionId = prescriptionId;
            document.getElementById('editPrescriptionId').value = prescriptionId;
            document.getElementById('editMedication').value = prescription.medication;
            document.getElementById('editDosage').value = prescription.dosage;
            document.getElementById('editFrequency').value = prescription.frequency;
            document.getElementById('editPharmacy').value = prescription.pharmacy;
            
            document.getElementById('editPrescriptionModal').style.display = 'block';
        }

        function closeEditPrescriptionModal() {
            document.getElementById('editPrescriptionModal').style.display = 'none';
            selectedPrescriptionId = null;
        }

        function updatePrescription(event) {
            event.preventDefault();
            
            const updatedData = {
                medication: document.getElementById('editMedication').value,
                dosage: document.getElementById('editDosage').value,
                frequency: document.getElementById('editFrequency').value,
                pharmacy: document.getElementById('editPharmacy').value
            };
            
            google.script.run
                .withSuccessHandler(() => {
                    closeEditPrescriptionModal();
                    loadPrescriptions();
                })
                .withFailureHandler(handleError)
                .editPrescription(selectedPrescriptionId, updatedData);
        }

        function showDeletePrescriptionModal(prescriptionId) {
            selectedPrescriptionId = prescriptionId;
            document.getElementById('deletePrescriptionModal').style.display = 'block';
        }

        function closeDeletePrescriptionModal() {
            document.getElementById('deletePrescriptionModal').style.display = 'none';
            selectedPrescriptionId = null;
        }

        function confirmPrescriptionDelete() {
            if (!selectedPrescriptionId) return;
            
            google.script.run
                .withSuccessHandler(() => {
                    closeDeletePrescriptionModal();
                    loadPrescriptions();
                })
                .withFailureHandler(handleError)
                .deletePrescription(selectedPrescriptionId);
        }

        function refillPrescription(prescriptionId) {
            google.script.run
                .withSuccessHandler(() => {
                    loadPrescriptions();
                })
                .withFailureHandler(handleError)
                .refillPrescription(prescriptionId);
        }

        let currentPatient = null;
        let providerAuthenticated = false;
        let loginAttempts = 0;

        // Page Navigation Functions
        function showAddPatientPage() {
            showPage('addPatientPage');
            initializeAddPatientForm();
        }

        function showSearchPatientPage() {
            showPage('searchPatientPage');
            showPasswordPrompt();
        }

        function showPasswordPrompt() {
            document.getElementById('passwordPrompt').style.display = 'block';
            document.getElementById('searchForm').style.display = 'none';
            document.getElementById('providerPassword').value = '';
            loginAttempts = 0;
        }

        function closePasswordPrompt() {
            document.getElementById('passwordPrompt').style.display = 'none';
            showPage('patientInfoPage');
        }

        // Authentication Functions
        function validateProviderAccess() {
            const password = document.getElementById('providerPassword').value;
            
            google.script.run
                .withSuccessHandler((result) => {
                    if (result) {
                        document.getElementById('passwordPrompt').style.display = 'none';
                        document.getElementById('searchForm').style.display = 'block';
                        providerAuthenticated = true;
                        loginAttempts = 0;
                    } else {
                        loginAttempts++;
                        if (loginAttempts >= 3) {
                            alert('Account locked due to too many failed attempts');
                            showPage('patientInfoPage');
                        } else {
                            alert('Incorrect password. Please try again.');
                        }
                    }
                })
                .withFailureHandler((error) => {
                    alert(error.message);
                    if (error.message.includes('locked')) {
                        showPage('patientInfoPage');
                    }
                })
                .validateProviderPassword(currentUser.username, password);
        }

        // Patient Management Functions
        function initializeAddPatientForm() {
            document.getElementById('addPatientForm').reset();
            document.getElementById('guardiansList').innerHTML = '';
            document.getElementById('conditionsList').innerHTML = '';
            addGuardianField();
            addConditionField();
        }

        function addGuardianField() {
            const container = document.createElement('div');
            container.className = 'guardian-entry form-group';
            container.innerHTML = `
                <input type="text" placeholder="Guardian Name" required>
                <input type="tel" placeholder="Guardian Phone (123-456-7890)" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" required>
                <button type="button" class="btn btn-secondary" onclick="removeField(this)">Remove</button>
            `;
            document.getElementById('guardiansList').appendChild(container);
        }

        function addConditionField() {
            const container = document.createElement('div');
            container.className = 'condition-entry form-group';
            container.innerHTML = `
                <input type="text" placeholder="Medical Condition" required>
                <button type="button" class="btn btn-secondary" onclick="removeField(this)">Remove</button>
            `;
            document.getElementById('conditionsList').appendChild(container);
        }

        function removeField(button) {
            button.parentElement.remove();
        }

        function createNewPatient(event) {
            event.preventDefault();
            
            const guardians = Array.from(document.getElementById('guardiansList').children).map(div => ({
                name: div.querySelector('input[type="text"]').value,
                phone: div.querySelector('input[type="tel"]').value
            }));
            
            const conditions = Array.from(document.getElementById('conditionsList').children).map(div => 
                div.querySelector('input').value
            );
            
            const patientData = {
                name: document.getElementById('patientName').value,
                sex: document.getElementById('patientSex').value,
                gender: document.getElementById('patientGender').value,
                insuranceInfo: document.getElementById('insuranceInfo').value,
                email: document.getElementById('patientEmail').value,
                phone: document.getElementById('patientPhone').value,
                guardians: guardians,
                medicalConditions: conditions,
                notes: document.getElementById('patientNotes').value,
                medicalHistory: document.getElementById('medicalHistory').value,
                createdBy: currentUser.username
            };
            
            google.script.run
                .withSuccessHandler(() => {
                    alert('Patient record created successfully');
                    showPage('patientInfoPage');
                })
                .withFailureHandler(handleError)
                .addPatient(patientData);
        }

        function searchForPatient() {
            if (!providerAuthenticated) {
                showPasswordPrompt();
                return;
            }
            
            const searchName = document.getElementById('searchName').value;
            const password = document.getElementById('providerPassword').value;
            
            google.script.run
                .withSuccessHandler(displaySearchResults)
                .withFailureHandler(handleError)
                .searchPatients(searchName, currentUser.username, password);
        }

        function displaySearchResults(patients) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            if (patients.length === 0) {
                container.innerHTML = '<p>No patients found</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'appointments-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Sex</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            patients.forEach(patient => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${patient.name}</td>
                    <td>${patient.sex}</td>
                    <td>${patient.email}</td>
                    <td>${patient.phone}</td>
                    <td>
                        <button onclick="viewPatient('${patient.id}')" class="btn btn-primary btn-sm">View</button>
                    </td>
                `;
                table.querySelector('tbody').appendChild(row);
            });
            
            container.appendChild(table);
        }

        function viewPatient(patientId) {
            const password = document.getElementById('providerPassword').value;
            
            google.script.run
                .withSuccessHandler(displayPatientDetails)
                .withFailureHandler(handleError)
                .getPatient(patientId, currentUser.username, password);
        }

        function displayPatientDetails(patient) {
            patient = JSON.parse(patient);
            currentPatient = patient;
            showPage('patientDetailsPage');
            
            // Display deletion warning if applicable
            const undoButton = document.querySelector('#patientDetailsForm button[onclick="undoChanges()"]');
            if (patient.deletionDate) {
                document.getElementById('deletionWarning').style.display = 'block';
                document.getElementById('deletionDate').textContent = new Date(patient.deletionDate).toLocaleDateString();
                // Update undo button text and onclick handler
                undoButton.textContent = 'Cancel Deletion';
                undoButton.onclick = handleUndoClick;
            } else {
                document.getElementById('deletionWarning').style.display = 'none';
                // Reset undo button text and onclick handler
                undoButton.textContent = 'Undo';
                undoButton.onclick = handleUndoClick;
            }
            
            // Populate form fields with current patient data
            document.getElementById('editPatientName').value = patient.name || '';
            document.getElementById('editPatientSex').value = patient.sex || '';
            document.getElementById('editPatientGender').value = patient.gender || '';
            document.getElementById('editInsuranceInfo').value = patient.insuranceInfo || '';
            document.getElementById('editPatientEmail').value = patient.email || '';
            document.getElementById('editPatientPhone').value = patient.phone || '';
            document.getElementById('editPatientNotes').value = patient.notes || '';
            document.getElementById('editMedicalHistory').value = patient.medicalHistory || '';
            
            // Populate guardians
            const guardiansContainer = document.getElementById('editGuardiansList');
            guardiansContainer.innerHTML = ''; // Clear existing entries
            if (patient.guardians && patient.guardians.length > 0) {
                patient.guardians.forEach(guardian => {
                    const container = document.createElement('div');
                    container.className = 'guardian-entry form-group';
                    container.innerHTML = `
                        <input type="text" placeholder="Guardian Name" value="${guardian.name || ''}" required>
                        <input type="tel" placeholder="Guardian Phone" value="${guardian.phone || ''}" 
                              pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" required>
                        <button type="button" class="btn btn-secondary" onclick="removeField(this)">Remove</button>
                    `;
                    guardiansContainer.appendChild(container);
                });
            } else {
                // Add one empty guardian field if none exist
                addGuardianField();
            }
            
            // Populate medical conditions
            const conditionsContainer = document.getElementById('editConditionsList');
            conditionsContainer.innerHTML = ''; // Clear existing entries
            if (patient.medicalConditions && patient.medicalConditions.length > 0) {
                patient.medicalConditions.forEach(condition => {
                    const container = document.createElement('div');
                    container.className = 'condition-entry form-group';
                    container.innerHTML = `
                        <input type="text" placeholder="Medical Condition" value="${condition || ''}" required>
                        <button type="button" class="btn btn-secondary" onclick="removeField(this)">Remove</button>
                    `;
                    conditionsContainer.appendChild(container);
                });
            } else {
                // Add one empty condition field if none exist
                addEditConditionField();
            }
        }

        function handleUndoClick() {
            if (!currentPatient) return;
            
            const password = document.getElementById('providerPassword').value;
            
            if (currentPatient.deletionDate) {
                // If patient is marked for deletion, cancel the deletion
                google.script.run
                    .withSuccessHandler(() => {
                        alert('Deletion cancelled successfully');
                        viewPatient(currentPatient.id);
                    })
                    .withFailureHandler(handleError)
                    .cancelPatientDeletion(currentPatient.id, currentUser.username, password);
            } else {
                // Otherwise, undo the last changes
                google.script.run
                    .withSuccessHandler(() => {
                        alert('Changes undone successfully');
                        viewPatient(currentPatient.id);
                    })
                    .withFailureHandler(handleError)
                    .undoPatientChanges(currentPatient.id, currentUser.username, password);
            }
        }

        function addEditConditionField() {
            const container = document.createElement('div');
            container.className = 'condition-entry form-group';
            container.innerHTML = `
                <input type="text" placeholder="Medical Condition" required>
                <button type="button" class="btn btn-secondary" onclick="removeField(this)">Remove</button>
            `;
            document.getElementById('editConditionsList').appendChild(container);
        }

        function confirmEditPatient() {
            document.getElementById('confirmationModal').style.display = 'block';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        function savePatientChanges() {
            const guardians = Array.from(document.getElementById('editGuardiansList').children)
                .map(div => ({
                    name: div.querySelector('input[type="text"]').value,
                    phone: div.querySelector('input[type="tel"]').value
                }))
                .filter(guardian => guardian.name && guardian.phone); // Only include filled out guardians
            
            const conditions = Array.from(document.getElementById('editConditionsList').children)
                .map(div => div.querySelector('input').value)
                .filter(condition => condition); // Only include non-empty conditions
            
            const updatedData = {
                name: document.getElementById('editPatientName').value,
                sex: document.getElementById('editPatientSex').value,
                gender: document.getElementById('editPatientGender').value,
                insuranceInfo: document.getElementById('editInsuranceInfo').value,
                email: document.getElementById('editPatientEmail').value,
                phone: document.getElementById('editPatientPhone').value,
                guardians: guardians,
                medicalConditions: conditions,
                notes: document.getElementById('editPatientNotes').value,
                medicalHistory: document.getElementById('editMedicalHistory').value
            };
            
            const password = document.getElementById('providerPassword').value;
            
            google.script.run
                .withSuccessHandler(() => {
                    closeConfirmationModal();
                    alert('Patient record updated successfully');
                    viewPatient(currentPatient.id);
                })
                .withFailureHandler(handleError)
                .updatePatient(currentPatient.id, updatedData, currentUser.username, password);
        }

        function showDeleteConfirmation() {
            document.getElementById('deleteConfirmationModal').style.display = 'block';
            document.getElementById('deletePassword').value = '';
        }

        function closeDeleteConfirmationModal() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
        }

        function confirmDeletePatient() {
            const password = document.getElementById('deletePassword').value;
            
            google.script.run
                .withSuccessHandler((deletionDate) => {
                    closeDeleteConfirmationModal();
                    viewPatient(currentPatient.id);
                })
                .withFailureHandler(handleError)
                .markPatientForDeletion(currentPatient.id, currentUser.username, password);
        }

        function undoChanges() {
            const password = document.getElementById('providerPassword').value;
            
            google.script.run
                .withSuccessHandler(() => {
                    alert('Changes undone successfully');
                    viewPatient(currentPatient.id);
                })
                .withFailureHandler(handleError)
                .undoPatientChanges(currentPatient.id, currentUser.username, password);
        }
    </script>
</body>
</html>
